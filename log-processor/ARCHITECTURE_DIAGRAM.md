# ðŸ—ï¸ Log Processor Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KAFKA CLUSTER (3 Brokers)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  Controller  â”‚  â”‚  Controller  â”‚  â”‚  Controller  â”‚                 â”‚
â”‚  â”‚      1       â”‚  â”‚      2       â”‚  â”‚      3       â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                          â”‚
â”‚  Topics:                                                                 â”‚
â”‚  â€¢ error-logs                                                           â”‚
â”‚  â€¢ error-logs-retry                                                     â”‚
â”‚  â€¢ error-logs-dlq                                                       â”‚
â”‚  â€¢ logs.error.dlq  â—„â”€â”€â”€ Log Processor consumes from this               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Kafka Consumer
                                    â”‚ (KafkaJS)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LOG PROCESSOR SERVICE                            â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  index.js - Main Consumer Service                              â”‚   â”‚
â”‚  â”‚  â€¢ Connect to Kafka                                             â”‚   â”‚
â”‚  â”‚  â€¢ Subscribe to logs.error.dlq                                  â”‚   â”‚
â”‚  â”‚  â€¢ Process messages                                             â”‚   â”‚
â”‚  â”‚  â€¢ Validate & parse JSON                                        â”‚   â”‚
â”‚  â”‚  â€¢ Find/Create Project & Function                               â”‚   â”‚
â”‚  â”‚  â€¢ Insert Log record                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â”‚ Prisma Client                      â”‚
â”‚                                    â”‚ (Type-safe ORM)                    â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Prisma ORM Layer                                               â”‚   â”‚
â”‚  â”‚  â€¢ Schema validation                                            â”‚   â”‚
â”‚  â”‚  â€¢ Connection pooling                                           â”‚   â”‚
â”‚  â”‚  â€¢ Query builder                                                â”‚   â”‚
â”‚  â”‚  â€¢ Type-safe operations                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ SQL Queries
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PostgreSQL DATABASE                             â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    projects      â”‚     â”‚    functions     â”‚     â”‚      logs      â”‚ â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚ id (PK)          â”‚â—„â”€â”  â”‚ id (PK)          â”‚â—„â”€â”  â”‚ id (PK)        â”‚ â”‚
â”‚  â”‚ name (UQ)        â”‚  â”‚  â”‚ name             â”‚  â”‚  â”‚ projectId (FK) â”‚â”€â”¤
â”‚  â”‚ createdAt        â”‚  â””â”€â”€â”‚ projectId (FK)   â”‚  â””â”€â”€â”‚ functionId (FK)â”‚â”€â”¤
â”‚  â”‚ updatedAt        â”‚     â”‚ createdAt        â”‚     â”‚ method         â”‚ â”‚
â”‚  â”‚                  â”‚     â”‚ updatedAt        â”‚     â”‚ type           â”‚ â”‚
â”‚  â”‚ Indexes:         â”‚     â”‚                  â”‚     â”‚ request*       â”‚ â”‚
â”‚  â”‚ â€¢ name           â”‚     â”‚ Indexes:         â”‚     â”‚ response*      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â€¢ projectId      â”‚     â”‚ consoleLog     â”‚ â”‚
â”‚                            â”‚ â€¢ name           â”‚     â”‚ latency        â”‚ â”‚
â”‚                            â”‚ â€¢ (projectId,    â”‚     â”‚ createdBy*     â”‚ â”‚
â”‚                            â”‚    name) UQ      â”‚     â”‚ createdAt      â”‚ â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ updatedAt      â”‚ â”‚
â”‚                                                      â”‚                â”‚ â”‚
â”‚                                                      â”‚ Indexes:       â”‚ â”‚
â”‚                                                      â”‚ â€¢ projectId    â”‚ â”‚
â”‚                                                      â”‚ â€¢ functionId   â”‚ â”‚
â”‚                                                      â”‚ â€¢ type         â”‚ â”‚
â”‚                                                      â”‚ â€¢ method       â”‚ â”‚
â”‚                                                      â”‚ â€¢ createdAt    â”‚ â”‚
â”‚                                                      â”‚ â€¢ responseCode â”‚ â”‚
â”‚                                                      â”‚ â€¢ + composites â”‚ â”‚
â”‚                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Queries
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         QUERY INTERFACES                                â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Prisma Studio (Web GUI)                                        â”‚   â”‚
â”‚  â”‚  http://localhost:5555                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  queries.js - Utility Functions                                 â”‚   â”‚
â”‚  â”‚  â€¢ getProjectsWithStats()                                       â”‚   â”‚
â”‚  â”‚  â€¢ getLogsByProject(projectId, page, limit)                     â”‚   â”‚
â”‚  â”‚  â€¢ getRecentErrors(limit)                                       â”‚   â”‚
â”‚  â”‚  â€¢ getLogStatsByType(projectId)                                 â”‚   â”‚
â”‚  â”‚  â€¢ getLogsByUser(userId, page, limit)                           â”‚   â”‚
â”‚  â”‚  â€¢ getAverageLatency(projectId, functionId)                     â”‚   â”‚
â”‚  â”‚  â€¢ ... and more                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Message Flow

```
1. Application Error Occurs
         â”‚
         â–¼
2. Error Message Sent to Kafka
         â”‚
         â”œâ”€â–º error-logs (main topic)
         â”‚       â”‚
         â”‚       â”œâ”€â–º Discord Webhook Service
         â”‚       â””â”€â–º FCM Service
         â”‚
         â””â”€â–º logs.error.dlq (DLQ topic)
                 â”‚
                 â–¼
3. Log Processor Consumes Message
         â”‚
         â”œâ”€â–º Validate Message
         â”‚
         â”œâ”€â–º Parse JSON
         â”‚
         â”œâ”€â–º Find/Create Project
         â”‚       â”‚
         â”‚       â””â”€â–º SELECT * FROM projects WHERE name = ?
         â”‚           If not found: INSERT INTO projects
         â”‚
         â”œâ”€â–º Find/Create Function  
         â”‚       â”‚
         â”‚       â””â”€â–º SELECT * FROM functions 
         â”‚           WHERE projectId = ? AND name = ?
         â”‚           If not found: INSERT INTO functions
         â”‚
         â””â”€â–º Insert Log Record
                 â”‚
                 â””â”€â–º INSERT INTO logs (
                       projectId, functionId, method, type,
                       requestHeaders, requestUserAgent, requestUrl,
                       requestParams, requestBody, responseCode,
                       responseSuccess, responseMessage, responseData,
                       consoleLog, additionalData, latency,
                       createdById, createdByFullname, 
                       createdByEmplCode, createdAt
                     )
                     â”‚
                     â–¼
4. Data Stored Successfully
         â”‚
         â””â”€â–º Available for Querying
                 â”‚
                 â”œâ”€â–º Prisma Studio
                 â”œâ”€â–º Query Functions
                 â””â”€â–º Analytics
```

## Data Relationships

```
Project "myapp"
    â”‚
    â”œâ”€â–º Function "login"
    â”‚       â”‚
    â”‚       â”œâ”€â–º Log #1 (ERROR - 500)
    â”‚       â”œâ”€â–º Log #2 (ERROR - 401)
    â”‚       â””â”€â–º Log #3 (SUCCESS - 200)
    â”‚
    â”œâ”€â–º Function "register"
    â”‚       â”‚
    â”‚       â””â”€â–º Log #4 (ERROR - 400)
    â”‚
    â””â”€â–º Function "getUserById"
            â”‚
            â”œâ”€â–º Log #5 (ERROR - 404)
            â””â”€â–º Log #6 (SUCCESS - 200)
```

## Query Examples Flow

```
User Request: "Get all error logs for myapp project"
         â”‚
         â–¼
getLogsByProject("myapp-uuid", 1, 20)
         â”‚
         â–¼
Prisma Query:
    SELECT logs.*, projects.*, functions.*
    FROM logs
    JOIN projects ON logs.projectId = projects.id
    JOIN functions ON logs.functionId = functions.id
    WHERE logs.projectId = 'myapp-uuid'
    ORDER BY logs.createdAt DESC
    LIMIT 20 OFFSET 0
         â”‚
         â–¼
Result: Paginated list of logs with relations
         â”‚
         â””â”€â–º {
               data: [ {...}, {...}, ... ],
               pagination: {
                 page: 1,
                 limit: 20,
                 total: 150,
                 totalPages: 8
               }
             }
```

## Docker Deployment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Compose Network: kafka-network                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  PostgreSQL  â”‚  â”‚    Kafka     â”‚  â”‚     Kafka    â”‚     â”‚
â”‚  â”‚  Container   â”‚  â”‚ Controller 1 â”‚  â”‚ Controller 2 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚                  â”‚             â”‚
â”‚         â”‚                  â”‚                  â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚           Log Processor Container                   â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â€¢ Auto push Prisma schema on startup               â”‚   â”‚
â”‚  â”‚  â€¢ Connect to PostgreSQL                            â”‚   â”‚
â”‚  â”‚  â€¢ Connect to Kafka                                 â”‚   â”‚
â”‚  â”‚  â€¢ Start consuming messages                         â”‚   â”‚
â”‚  â”‚  â€¢ Restart: unless-stopped                          â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Index Strategy Visualization

```
logs table: 1,000,000 records

Query: "Get errors for project X in last 24h"
         â”‚
         â–¼
WHERE projectId = 'X'        â—„â”€â”€ Uses index: projectId
  AND type = 'ERROR'         â—„â”€â”€ Uses index: (projectId, type) composite
  AND createdAt > '...'      â—„â”€â”€ Uses index: (projectId, createdAt) composite
         â”‚
         â–¼
Result: Fast query (~10ms) instead of full table scan (~5000ms)
```

## Scalability

```
Current:
  1 Log Processor Instance
  1 PostgreSQL Instance
  3 Kafka Brokers

Scale Horizontally:
  â”œâ”€â–º Add more Log Processor instances
  â”‚   (Kafka consumer group will auto-balance partitions)
  â”‚
  â”œâ”€â–º Add PostgreSQL read replicas
  â”‚   (For analytics queries)
  â”‚
  â””â”€â–º Add more Kafka partitions
      (Better parallelism)

Scale Vertically:
  â”œâ”€â–º Increase PostgreSQL resources
  â”‚   (More RAM for caching, faster disk)
  â”‚
  â””â”€â–º Increase Log Processor resources
      (More CPU for message processing)
```
